#
#		Makefile for ECoLisp
#
top_srcdir= @top_srcdir@
srcdir	= @srcdir@
VPATH	= @srcdir@

MACHINE = @MACHINE@

# Programs used by "make":
#

CC	= @CC@
DEFS	= -D$(MACHINE)
LIBS	= @LIBS@ @TKLIBS@ @CLIBS@
CFLAGS	= @CFLAGS@
LDFLAGS	= @LDFLAGS@

#ifdef __GO32__
EXE	= go32
#elif defined(__EMX__)
EXE	= emx
#else
EXE	=
#endif

SHELL	= /bin/sh
RM	= @RM@

# ==================== Where To Install Things ====================

# The default location for installation.  Everything is placed in
# subdirectories of this directory.  The default values for many of
# the variables below are expressed in terms of this one, so you may
# not need to change them.  This defaults to /usr/local.
bindir=@bindir@
libdir=@libdir@
mandir=@mandir@
manext=.1
infodir=@infodir@

# Programs used by "make install":
#
INSTALL	= @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@

# Files

SUBDIR	= c gmp crs
LIBRARIES = libecls.a libcrs.a
TARGETS = ecls
#ifndef HAVE_LOCAL_GMP
LIBRARIES += libgmp.a
#endif
#ifdef GBC_BOEHM
SUBDIR += gc
LIBRARIES += libgc.a
#endif GBC_BOEHM
LSP_LIBRARIES = liblsp.a
#ifdef CLOS
LSP_LIBRARIES += libclos.a
#endif
#ifndef RUNTIME
LSP_LIBRARIES += libcmp.a
#endif
#ifdef CLX
TARGETS += eclx
LSP_LIBRARIES += libclx.a
#endif

# The makefiles of the directories in $SUBDIR.
# Don't split this line: configure does grep on it
SUBDIR_MAKEFILES= c/Makefile crs/Makefile tk/Makefile doc/Makefile gc/Makefile

all:	$(TARGETS) doc
.PHONY:	all

%Makefile: $(srcdir)/%Makefile.in config.status
	./config.status

eclx: ecls compile_rest.lsp
	./ecls < compile_rest.lsp

ecls: ecls_min compile.lsp
	./ecls_min < compile.lsp

ecls_min: $(LIBRARIES) @RSYM@ .gdbinit
	$(CC) $(LDFLAGS) -o $@ c/cinit.o -L./ $(LIBRARIES) $(LIBS)
	test "@RSYM@" = "" || ./rsym ecls_min ecls_min.sym

.gdbinit: $(srcdir)/util/gdbinit
	cp $(srcdir)/util/gdbinit $@

libecls.a:
	cd c; $(MAKE)
libgc.a:
	cd gc; $(MAKE)
libcrs.a @RSYM@:
	cd crs; $(MAKE)
	test "@RSYM@" = "" || cp crs/@RSYM@ .
libgmp.a:
	cd gmp; $(MAKE); cp .libs/libgmp.a ..

BUILD-STAMP: config.status
	(echo "#"; uname -a) > $@
	head -8 config.status | tail -6 >> $@
install: BUILD-STAMP
	for i in $(TARGETS); do	$(INSTALL_PROGRAM) $$i $(PREFIX)$(bindir); strip $(PREFIX)$(bindir)/$$i; done
	$(INSTALL_DATA) $(srcdir)/etc/ecls.1 $(PREFIX)$(mandir)
	test -d $(PREFIX)$(libdir) || (mkdir $(PREFIX)$(libdir); chmod 755 $(PREFIX)$(libdir))
	test -d $(PREFIX)$(libdir)/h || (mkdir $(PREFIX)$(libdir)/h; chmod 755 $(PREFIX)$(libdir)/h)
	for i in $(TARGETS); do $(INSTALL_PROGRAM) $$i.sym $(PREFIX)$(libdir); done
	$(INSTALL_DATA) BUILD-STAMP $(PREFIX)$(libdir)
	$(INSTALL_DATA) h/config.h $(PREFIX)$(libdir)/h
#ifndef HAVE_LOCAL_GMP
	$(INSTALL_DATA) gmp/?*.h $(PREFIX)$(libdir)/h
	$(INSTALL_DATA) $(srcdir)/gmp/?*.h $(PREFIX)$(libdir)/h
#endif
	for i in $(LSP_LIBRARIES) $(LIBRARIES); do \
	$(INSTALL_DATA) $$i $(PREFIX)$(libdir); \
	done
#ifdef GBC_BOEHM
	for i in $(srcdir)/gc/include/?*.h; do $(INSTALL_DATA) $$i $(PREFIX)$(libdir)/h/`basename $$i`; done
	test -d $(PREFIX)$(libdir)/h/private  || (mkdir $(PREFIX)$(libdir)/h/private; chmod 755 $(PREFIX)$(libdir)/h/private)
	for i in $(srcdir)/gc/include/private/?*.h; do $(INSTALL_DATA) $$i $(PREFIX)$(libdir)/h/private/`basename $$i`; done
#endif GBC_BOEHM
	test "@RSYM@" = "" || $(INSTALL_PROGRAM) @RSYM@ $(PREFIX)$(libdir)
	cd c; $(MAKE) PREFIX="$(PREFIX)" install
	cd doc; $(MAKE) PREFIX="$(PREFIX)" install

uninstall:
	rm -rf $(mandir)/ecls.1
	rm -rf $(bindir)/ecls
	rm -rf $(libdir)
	cd doc; $(MAKE) uninstall

doc: $(TARGETS)
	cd doc; $(MAKE)

clean: clean_lisp
	for i in ${SUBDIR}; do (cd $$i; make clean); done
	$(RM) ecls_min ecls_min.sym ecls ecls.sym help.doc core a.out
	$(RM) config.version config.log config.cache
	$(RM) *.c *.o *.a *.h *.data
clean_lisp:
	for i in lsp cmp clos clx tk; do rm -f lib$$i.a $$i/?*.o $$i/?*.c $$i/?*.data $$i/?*.h; done
distclean: clean
realclean: distclean
test1:
	cd c; make
	make ecls_min
	make ecls
	cd tests; make
	diff tests tests2
test2:
	make clean_lisp
	cd c; make
	make ecls_min
	$(RM) ecls
	make ecls
	for i in lsp clos cmp; do diff --exclude=\*.o $$i old/$$i; done
test3:
	-mkdir stage2
	cp -rf lsp clos cmp stage2
	-for i in lsp cmp clos clx tk; do test -f lib$$i.a && mv lib$$i.a stage2; done
	make clean_lisp
	./ecls < compile2.lsp
	for i in lsp clos cmp clx tk; do test -d $$i && diff --exclude=\*.o $$i stage2/$$i; done