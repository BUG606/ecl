#
#		Makefile for ECoLisp
#
top_srcdir= @top_srcdir@
srcdir	= @srcdir@

# Programs used by "make":
#

@SET_MAKE@
CC	= @ECL_CC@
LIBS	= @LIBS@
FASL_LIBS = @FASL_LIBS@
CORE_LIBS = @CORE_LIBS@
LDFLAGS	= @LDFLAGS@
RM	= @RM@
LN_S	= @LN_S@
EXE	= @EXEEXT@

# ==================== Where To Install Things ====================

# The default location for installation.  Everything is placed in
# subdirectories of this directory.  The default values for many of
# the variables below are expressed in terms of this one, so you may
# not need to change them.  This defaults to /usr/local.
prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
libdir=@libdir@
includedir=@includedir@

# Programs used by "make install":
#
SHELL = @SHELL@
INSTALL	= @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_SCRIPT = @INSTALL_SCRIPT@
INSTALL_DATA = @INSTALL_DATA@
mkinstalldirs = $(SHELL) $(top_srcdir)/gc/mkinstalldirs

# Files

SUBDIRS = @SUBDIRS@
LIBRARIES = @LIBRARIES@
LSP_LIBRARIES = @LSP_LIBRARIES@
TARGETS = @TARGETS@

all:	$(TARGETS) bin/ecl-config doc
.PHONY:	all

%Makefile: $(srcdir)/%Makefile.in config.status
	./config.status

#
# When compiling the library itself, we have to remove the dllimport
# declarations, because the variables that they mark are in the
# in the library and can be referenced without indirection.
#
c/ecl/external.h: $(top_srcdir)/h/external.h
	-mkdir c/ecl
	sed 's,__declspec(dllimport),,g' $(top_srcdir)/h/external.h > $@
ecl/external.h: c/ecl/external.h c/ecl/external.h
	cp $(srcdir)/h/*.h ecl/
	if grep 'undef ENABLE_DLOPEN' ecl/config.h; then cp c/external.h h; fi

bin/ecl$(EXE): ecl_min$(EXE) compile.lsp sysfun.lsp ecl/external.h BUILD-STAMP
	if [ -f CROSS-COMPILER ]; then \
		./CROSS-COMPILER < compile.lsp; \
	else \
		./ecl_min < compile.lsp; \
	fi

ecl_min$(EXE): $(LIBRARIES) .gdbinit @LIBPREFIX@eclmin.@LIBEXT@
	if [ -f CROSS-COMPILER ]; then \
		touch $@; \
	else \
		$(CC) $(LDFLAGS) -o $@ cinit.o c/all_symbols.o -L./ @LIBPREFIX@eclmin.@LIBEXT@ $(CORE_LIBS) $(LIBS) $(FASL_LIBS);\
	fi

.gdbinit: $(srcdir)/util/gdbinit
	cp $(srcdir)/util/gdbinit $@

lsp/config.lsp: lsp/config.pre
	sed -e 's,@ecldir@,$(libdir),g' < lsp/config.pre > lsp/config.lsp
cmp/cmpdefs.lsp: cmp/cmpdefs.pre
	sed -e 's,@ecldir@,"$(libdir)",g' \
	    -e 's,@ecllibdir@,"$(libdir)",g' \
	    -e 's,@eclincludedir@,"$(includedir)",g' < cmp/cmpdefs.pre > $@
compile.lsp: compile.pre
	sed -e 's,@ecldir@,$(libdir),g' < compile.pre > compile.lsp
bin/ecl-config: bin/ecl-config.pre
	sed -e 's,~A,$(libdir),;s,~\*,,' \
	    -e 's,@ecllibdir\\@,$(libdir),' \
	    -e 's,@ecincludedir\\@,$(includedir),' bin/ecl-config.pre > bin/ecl-config


@LIBPREFIX@eclmin.@LIBEXT@: @LIBPREFIX@eclgmp.@LIBEXT@ @LIBPREFIX@eclgc.@LIBEXT@ lsp/config.lsp cmp/cmpdefs.lsp ecl/external.h
	cd c; $(MAKE)
@LIBPREFIX@eclgc.@LIBEXT@:
	if (echo $(SUBDIRS) | grep gc); then \
	  cd gc; $(MAKE) install; \
	  cd ..; rm -rf ecl/gc; mv h/* ecl/; \
	  cp -rf $(srcdir)/gc/include/private ecl/gc/; \
	  mv @LIBPREFIX@gc.@LIBEXT@ @LIBPREFIX@eclgc.@LIBEXT@; \
	fi
@LIBPREFIX@eclgmp.@LIBEXT@:
	if (echo $(SUBDIRS) | grep gmp); then \
	  cd gmp; $(MAKE) install; \
	  mv ../@LIBPREFIX@gmp.@LIBEXT@ ../@LIBPREFIX@eclgmp.@LIBEXT@; \
	fi
sysfun.lsp:
	$(LN_S) $(srcdir)/cmp/sysfun.lsp ./

rt.lisp:
	cp $(srcdir)/../contrib/rt/rt.lisp ./

BUILD-STAMP: config.status
	echo "#" `uname -a` > $@
	head -8 config.log | tail -6 >> $@
install: install-base
	cd c; $(MAKE) prefix=$(prefix) DESTDIR=$(DESTDIR) install
	cd doc; $(MAKE) prefix=$(prefix) DESTDIR=$(DESTDIR) install
install-base:
	$(mkinstalldirs) $(DESTDIR)$(bindir) $(DESTDIR)$(libdir) $(DESTDIR)$(includedir)/ecl
	# Here we would use the option -s but the install program in sourceforge-solaris
	# is broken.
	for i in $(TARGETS); do \
	  $(INSTALL_PROGRAM) $$i $(DESTDIR)$(bindir); \
	done;
	$(INSTALL_SCRIPT) bin/ecl-config $(DESTDIR)$(bindir)
	for i in BUILD-STAMP help.doc ; do \
	  $(INSTALL_DATA) $$i $(DESTDIR)$(libdir); \
	done
	for i in $(LSP_LIBRARIES) $(LIBRARIES) c/dpp* ecl_min*; do \
	  test -s $$i && $(INSTALL_PROGRAM) $$i $(DESTDIR)$(libdir) || : ; \
	done
	for i in `cat MODULES`; do \
	  $(INSTALL_PROGRAM) $$i $(DESTDIR)$(libdir); \
	done
flatinstall: BUILD-STAMP
	$(MAKE) DESTDIR=$(DESTDIR) bindir=$(prefix) libdir=$(prefix) install-base
	cd c; $(MAKE) DESTDIR=$(DESTDIR) prefix=$(prefix) flatinstall
	cd doc; $(MAKE) DESTDIR=$(DESTDIR) prefix=$(prefix) docdir=$(prefix)/doc flatinstall

uninstall:
	for i in $(TARGETS) ecl-config; do $(RM) $(DESTDIR)$(bindir)/$$i; done
	$(RM) -r $(DESTDIR)$(libdir)
	cd doc; $(MAKE) uninstall

doc: $(TARGETS)
	cd doc; $(MAKE)

clean: clean_lisp
	for i in $(SUBDIRS); do (cd $$i; $(MAKE) clean); done
	$(RM) ecl_min$(EXE) bin/ecl$(EXE) help.doc core a.out
	$(RM) config.version config.log config.cache
	$(RM) *.c *.o *.a *.h *.data *.fas
clean_lisp:
	for i in lsp cmp clos clx tk ext; do $(RM) lib$$i.a $$i/?*.{o,data,c,sdat,h,fas}; done
	$(RM) help.doc
distclean: clean
realclean: distclean
test1:
	cd c; $(MAKE)
	$(MAKE) ecl_min
	$(MAKE) ecl
	cd tests; $(MAKE)
	diff tests tests2
test2:
	$(MAKE) clean_lisp
	cd c; $(MAKE)
	$(MAKE) ecl_min
	$(RM) ecl
	$(MAKE) ecl
	for i in lsp clos cmp; do diff --exclude=\*.o $$i old/$$i; done
test3:
	-mkdir stage2
	cp -rf lsp clos cmp stage2
	-for i in lsp cmp clos clx tk; do test -f lib$$i.a && mv lib$$i.a stage2; done
	$(MAKE) clean_lisp
	./ecl < compile.lsp
	-for i in lsp clos cmp clx tk; do test -d $$i && diff --exclude=\*.o $$i stage2/$$i; done | less
test:
	$(MAKE) -C tests
	$(MAKE) -C ansi-tests > ansi-tests/log
	#-(diff tests ~/src/tests; diff --exclude log ansi-tests ~/src/ansi-tests) | less

TAGS:
	etags -R --langmap=c:+.d
