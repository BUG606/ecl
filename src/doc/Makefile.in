top_srcdir= @top_srcdir@
srcdir	= @srcdir@

prefix=@prefix@
exec_prefix=@exec_prefix@
infodir = @infodir@
mandir=@mandir@
manext=1

INFOEXT = @INFOEXT@
SHELL = @SHELL@
INSTALL	= @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_INFO = @INSTALL_INFO@
mkinstalldirs = $(SHELL) $(top_srcdir)/gc/mkinstalldirs

VERSION=@ECL_VERSION@

HTML = index.html license.html lgpl.html news.html benchmark.html \
	install.html download.html

FILTER = sed 's,@VERSION@,$(VERSION),g'

ECL = ../ecl

all: ecl.$(INFOEXT) ecldev.$(INFOEXT) $(HTML)

ecl.dvi: $(srcdir)/user.txi $(srcdir)/macros.txi clisp.sty ecl.sty
	tex $(srcdir)/user.txi
ecldev.dvi: $(srcdir)/devel.txi $(srcdir)/macros.txi clisp.sty ecl.sty
	tex $(srcdir)/devel.txi

ecl.ps: ecl.dvi $(srcdir)/macros.txi
	dvips -o $@ ecl.dvi
ecldev.ps: ecldev.dvi $(srcdir)/macros.txi
	dvips -o $@ ecldev.dvi

install: all
	$(mkinstalldirs) $(infodir)
	$(INSTALL_DATA) ecl.$(INFOEXT) $(infodir);
	$(INSTALL_DATA) ecldev.$(INFOEXT) $(infodir);
	if [ -x $(INSTALL_INFO) ]; then \
	  $(INSTALL_INFO) --infodir=$(infodir) ecl.$(INFOEXT); \
	  $(INSTALL_INFO) --infodir=$(infodir) ecldev.$(INFOEXT); \
	fi
	$(mkinstalldirs) $(mandir)/man$(manext)
	$(INSTALL_DATA) ecl.man $(mandir)/man$(manext)/ecl.$(manext)
flatinstall: all
	$(mkinstalldirs) $(prefix)/doc
	$(INSTALL_DATA) ecl.$(INFOEXT) $(prefix)/doc
	$(INSTALL_DATA) ecldev.$(INFOEXT) $(prefix)/doc
	if [ -f user.html ]; then \
	  $(INSTALL_DATA) $$i $(prefix)/doc/; \
	else \
	  $(mkinstalldirs) $(prefix)/doc/ecl; \
	  for i in ecl/*; do $(INSTALL_DATA) $$i $(prefix)/doc/ecl/; done; \
	fi
	if [ -f devel.html ]; then \
	  $(INSTALL_DATA) devel.html $(prefix)/doc/; \
	else \
	  $(mkinstalldirs) $(prefix)/doc/ecldev; \
	  for i in ecldev/*; do $(INSTALL_DATA) $$i $(prefix)/doc/ecldev/; done; \
	fi
	for i in *.html; do $(INSTALL_DATA) $$i $(prefix)/doc/; done

uninstall:
	if [ -x $(INSTALL_INFO) ]; then \
	  $(INSTALL_INFO) --delete ecl.$(INFOEXT); \
	  $(INSTALL_INFO) --delete ecl.$(INFOEXT); \
	fi
	rm -r $(infodir)/ecl.$(INFOEXT) $(infodir)/ecldev.$(INFOEXT); \
	rm $(mandir)/man$(manext)/ecl.$(manext)

head: developers_manual user_manual $(srcdir)/head
	if [ -f ecl/index.html ]; then \
	  sed -e 's,ecl/user.html,ecl/index.html,g' \
	      -e 's,ecldev/devel.html,ecldev/index.html,g' $(srcdir)/head > head; \
	else \
	  cp $(srcdir)/head head; \
	fi
ecl.info.gz: ecl.info
	gzip < ecl.info > ecl.info.gz
ecldev.info.gz: ecldev.info
	gzip < ecldev.info > ecldev.info.gz
ecl.info: $(srcdir)/user.txi $(srcdir)/macros.txi
	makeinfo -I $(srcdir) --no-split $(srcdir)/user.txi
ecldev.info: $(srcdir)/devel.txi $(srcdir)/macros.txi
	makeinfo -I $(srcdir) --no-split $(srcdir)/devel.txi

download.html: $(srcdir)/download.in.html head
	cat head $(srcdir)/download.in.html $(srcdir)/end | $(FILTER) > $@
index.html: $(srcdir)/index.in.html head
	cat head $(srcdir)/index.in.html $(srcdir)/end | $(FILTER) > $@
install.html: $(srcdir)/install.in.html head
	cat head $(srcdir)/download.in.html $(srcdir)/end | $(FILTER) > $@
news.html: $(srcdir)/news.in.html head
	(cat head; sed -e '/^----.*$$/,$$d' $(srcdir)/news.in.html; \
	 sed -e '1,/^ECL [0-9\.]*$$/d;/^===*$$/d' $(srcdir)/../../ANNOUNCEMENT| sed -e '1d'; \
	 sed -e '1,/^----*$$/d' $(srcdir)/news.in.html; \
	 cat $(srcdir)/end) | $(FILTER) > $@
benchmark.html: $(srcdir)/benchmark.in.html ../gabriel/BENCHMARK head
	(cat head; cat $(srcdir)/benchmark.in.html; \
	 echo '<pre>'; cat ../gabriel/BENCHMARK; echo '</pre>'; \
	 cat $(srcdir)/end) | $(FILTER) > $@
../gabriel/BENCHMARK:
	echo "No benchmarks available" > $@
license.html: $(top_srcdir)/../Copyright head
	(cat head; \
	 echo '<pre>'; cat $(top_srcdir)/../Copyright; echo '</pre>'; \
	 cat $(srcdir)/end) | $(FILTER) > $@
lgpl.html: $(top_srcdir)/../LGPL head
	(cat head; \
	 echo '<pre>'; cat $(top_srcdir)/../LGPL; echo '</pre>'; \
	 cat $(srcdir)/end) | $(FILTER) > $@
user_manual: $(srcdir)/user.txi $(srcdir)/macros.txi
	echo "Producing ecl.html; ignore error messages."
	test -d ecl || mkdir ecl; \
	(texi2html -I=$(srcdir) -subdir=ecl -split=chapter $(srcdir)/user.txi \
	|| (makeinfo -I $(srcdir) --html $(srcdir)/user.txi)) \
	&& touch user_manual
developers_manual: $(srcdir)/devel.txi $(srcdir)/macros.txi
	echo "Producing ecldev.html; ignore error messages."
	test -d ecldev || mkdir ecldev; \
	(texi2html -I=$(srcdir) -subdir=ecldev -split=chapter $(srcdir)/devel.txi \
	|| (makeinfo -I $(srcdir) --html $(srcdir)/devel.txi)) \
	&& touch developers_manual
clean:
	rm -r -f ecl ecldev ecl.info* ecldev.info* *.html user_manual developers_manual
