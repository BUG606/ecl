top_srcdir=@top_srcdir@
srcdir=@srcdir@

FILES =  CMUCLc ECLc CLISPc CMUCLi ECLi CLISPi
LISP ?= ../ecl -dir `pwd`/../
NAME ?= ECLc
COMPILE ?= NIL

BENCHMARK: $(FILES)
	rm -f BENCHMARK
	(echo "(load \"$(srcdir)/test-help.lsp\")"; \
	 echo "(beautify-output \"BENCHMARK\")"; \
	 cat $(FILES); \
	 echo "NIL";)\
	| ../ecl ; cat BENCHMARK

CMUCLi:
	make test LISP="lisp" NAME=CMUCLi COMPILE="NIL"
CMUCLc:
	make test LISP="lisp" NAME=CMUCLc COMPILE="T"
CLISPi:
	make test LISP="clisp -a" NAME=CLISPi COMPILE="NIL"
CLISPc:
	make test LISP="clisp -a" NAME=CLISPc COMPILE="T"
ECLi:
	make test NAME=ECLi COMPILE="NIL"
ECLc: ../h/ecl.h
	make test NAME=ECLc COMPILE="T"

test:
	(echo "(load \"$(srcdir)/make-declare.lsp\")"; \
	 echo "(load \"$(srcdir)/test-help.lsp\")"; \
	 echo "(do-all-tests \"$(NAME)\" \"$(srcdir)/\" \""`pwd`"/\" $(COMPILE))"; \
	 echo "#+(or cmu ecl) (quit)") | $(LISP)

../h/ecl.h:
	ln -sf $(top_srcdir)/h/*.h ../h

clean:
	rm -f $(FILES) BENCHMARK
	rm -f core *.fas *.c *.h a.out *.o *.lbin *.bin *.*fasl *~ *.lib *#
	rm -f *.x86f
