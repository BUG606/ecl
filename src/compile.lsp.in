;;;
;;; This is the "makefile" file for building ECL. The purpose of this file is
;;;	- Compile the core of the Common-Lisp library (lsp, clos)
;;;	- Compile the compiler (cmp)
;;;	- Build an executable
;;; This can be done in two ways:
;;;	- Using interpreted code and the ECL_MIN minimal environment.
;;;	- On a second stage, using the final ECL executable, to test it.
;;;

;;;
;;; * Ensure that we have the whole of Common-Lisp to compile
;;;
(load "bare.lsp" :verbose nil)

;;;
;;; * Dump documentation
;;;
#+stage1
(progn
  (load "@srcdir@/doc/help.lsp")
  (si::dump-documentation "@abs_builddir@/help.doc"))

;;;
;;; * Trick to make names shorter in C files
;;;
(si::package-lock "CL" nil)
(rename-package "CL" "CL" '("COMMON-LISP" "LISP"))

;;;
;;; * Compile, load and link Common-Lisp base library
;;;
(setq si::*keep-documentation* nil)
(proclaim '(optimize (safety 2) (space 3)))
(let ((objects (compile-if-old "@abs_builddir@/lsp/" +lisp-module-files+
			       :system-p t :c-file t :data-file t :h-file t)))
  (c::build-static-library "lsp" :lisp-files objects))

(si::pathname-translations "SYS" '(("**;*.*" "@abs_builddir@/**/*.*")))
(setq compiler::*cc-flags* (concatenate 'string compiler::*cc-flags* " -I@srcdir@/h -I@srcdir@/gmp -I@builddir@/h"))

;;;
;;; * Compile, load and link PCL based Common-Lisp Object System
;;;
(proclaim '(optimize (safety 2) (space 3)))
#+CLOS
(let* ((c::*compile-to-linking-call* nil)
       (objects (compile-if-old "@abs_builddir@/clos/" +clos-module-files+
				:system-p t :c-file t :data-file t :h-file t)))
  (c::build-static-library "clos" :lisp-files objects))

(si::system (format nil "
(test -d tmp || mkdir tmp); ~
cd tmp; rm -f *; ~
ar -x ../@LIBPREFIX@lsp.@LIBEXT@; for i in *.@OBJEXT@; do mv $i lsp_$i; done; ar -r ../@LIBPREFIX@ecl.@LIBEXT@ *.@OBJEXT@; rm *.@OBJEXT@; ~
ar -x ../@LIBPREFIX@clos.@LIBEXT@; for i in *.@OBJEXT@; do mv $i lsp_$i; done; ar -r ../@LIBPREFIX@ecl.@LIBEXT@ *.@OBJEXT@; rm *.@OBJEXT@; ~
@RANLIB@ ../@LIBPREFIX@ecl.@LIBEXT@; ~
cd ..; rm -rf tmp/* @LIBPREFIX@{lsp,clos} "))

;;
;; Notice that we must explicitely mention libecl.so/ecl.dll instead
;; of using -lecl. This is to avoid interference with an already
;; installed copy of ECL.
;;
(setf c::*ld-flags*
#+dlopen "@LDFLAGS@ @LDRPATH@ @SHAREDPREFIX@ecl.@SHAREDEXT@ @CLIBS@"
#-dlopen "@LDFLAGS@ @LDRPATH@ @LIBPREFIX@ecl.@LIBEXT@ @CLIBS@"
)

#+dlopen
;;
;; We do not need the -rpath flag for the library, nor -lecl.
;;
(let ((c::*ld-shared-flags* "@SHARED_LDFLAGS@ -lgmp -lgc @CLIBS@"))
  (c::shared-cc (compile-file-pathname "ecl" :type :dll)
		"c/main.@OBJEXT@"
		(compile-file-pathname "ecl" :type :lib)
		#+boehm-gc "-lgc"
		"-lgmp"
		. #.(unless (equalp "@LDINSTALLNAME@" "")
			'("@LDINSTALLNAME@"))))

;;;
;;; * Compile, load and link Common-Lisp to C compiler
;;;
(proclaim '(optimize (safety 2) (space 3)))
#+(or (not stage1) WANTS-CMP)
(let ((objects (compile-if-old "@abs_builddir@/cmp/" +cmp-module-files+
				:system-p t :c-file t :data-file t :h-file t)))
  (c::build-static-library "cmp" :lisp-files objects)
  #+dlopen
  (c::build-fasl "cmp" :lisp-files objects))

(si::pathname-translations "SYS" '(("**;*.*" "@libdir@/**/*.*")))

(compiler::build-program
 #+(or cross stage1) "ecl"
 #-(or cross stage1) "ecl2"
 :lisp-files '(#+(and (not dlopen) WANTS-CMP) cmp)
 :ld-flags '("-L./"))

#+WANTS-CLX
(progn
  (proclaim '(optimize (safety 2) (space 3)))
  (load "clx/load.lsp")
  (push :clx-ansi-common-lisp *features*)
  (let* ((objects (compile-if-old "@abs_builddir@/clx/" +clx-module-files+
				  :system-p t :c-file t :data-file t :h-file t)))
    (c::build-program "eclx" :lisp-files `(#+(and (not dlopen) wants-cmp) cmp
					   ,@objects))))

(quit)
